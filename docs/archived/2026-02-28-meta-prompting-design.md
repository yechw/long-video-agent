# Meta-Prompting 功能设计文档

**创建日期**: 2026-02-28
**功能名称**: Prompt 优化器 (Meta-Prompting)
**设计状态**: 已确认

---

## 1. 功能概述

### 1.1 目标
为用户提供一个嵌入式工具，让用户在聊天过程中可以优化自己编写的 Prompt，优化后立即用于当前对话。

### 1.2 使用场景
- 用户写了一个 Prompt，但感觉表达不够清晰
- 用户想要让 Prompt 输出更稳定的 JSON 格式
- 用户希望减少 Prompt 的 Token 使用量
- 用户想要增强 Prompt 的约束条件

---

## 2. 用户流程

```
用户输入 Prompt ──→ 点击"🔧 优化"按钮 ──→ 弹出优化对话框
                                              │
                                              ↓
              ┌─────────────────────────────────────────────────┐
              │          Prompt 优化对话框                        │
              │                                                   │
              │  [原始 Prompt 预览区]                              │
              │                                                   │
              │  [优化目标]                                        │
              │    ○ 更清晰  ○ 更简洁  ○ 更严格  ○ 自定义...      │
              │                                                   │
              │  选择"自定义"后展开输入框...                        │
              │                                                   │
              │  [优化按钮]                                        │
              │                                                   │
              │  [优化结果 + 改进说明]                             │
              │                                                   │
              │  [使用优化版本]  [取消]                            │
              └─────────────────────────────────────────────────┘
                              │
                              ↓
              点击"使用优化版本"──→ 替换输入框内容，关闭对话框
```

---

## 3. 技术架构

### 3.1 后端 API

#### POST /api/prompt/optimize
优化用户输入的 Prompt。

**请求体**:
```json
{
  "originalPrompt": "请总结这个视频",
  "optimizationGoal": "CLEARER",
  "customGoal": null
}
```

**目标类型枚举**:
- `CLEARER` - 更清晰
- `CONCISE` - 更简洁
- `STRICT` - 更严格
- `COMPLETE` - 更完整
- `CUSTOM` - 自定义

**响应体**:
```json
{
  "optimizedPrompt": "基于以下视频字幕生成结构化总结...",
  "improvements": [
    "添加了明确的输入格式说明",
    "使用具体动词替代模糊表达",
    "补充了输出结构要求"
  ]
}
```

### 3.2 前端组件

| 组件 | 路径 | 功能 |
|------|------|------|
| PromptOptimizer | `components/PromptOptimizer.vue` | 优化对话框 |
| ChatPanel | `components/ChatPanel.vue` (修改) | 添加优化按钮 |

### 3.3 Prompt 模板

**位置**: `src/main/resources/prompts/meta-optimize/v1.st`

```
你是一位专业的 Prompt Engineering 专家。

请根据以下要求优化用户提供的 Prompt：

【优化目标】
<goal>

【原始 Prompt】
<original_prompt>

【输出要求】
1. 输出优化后的完整 Prompt
2. 列出 2-5 条具体的改进说明
3. 使用以下 JSON 格式输出：

{
  "optimizedPrompt": "优化后的 Prompt 内容",
  "improvements": ["改进点1", "改进点2", ...]
}

注意：只输出 JSON，不要有任何其他内容。
```

---

## 4. 预设优化目标

| 预设 | 内部标识 | 对 AI 的指令 |
|------|---------|-------------|
| 更清晰 | `CLEARER` | 消除模糊表达，使用明确的动词和结构，添加具体的输入输出格式说明 |
| 更简洁 | `CONCISE` | 精简表达，去除重复和多余修饰词，合并冗余句子，减少 Token 使用量 |
| 更严格 | `STRICT` | 添加强制性约束，明确要求基于上下文回答，禁止编造，增强防幻觉能力 |
| 更完整 | `COMPLETE` | 补充 Few-Shot 示例，定义输出格式，添加边界情况处理说明 |
| 自定义 | `CUSTOM` | 根据用户自定义描述进行优化：`<custom_description>` |

---

## 5. 界面设计

### 5.1 触发方式
- 在聊天输入框右侧添加"🔧 优化"按钮
- 仅在输入框有内容时显示

### 5.2 对话框布局
```
┌─────────────────────────────────────────────────────┐
│  🔧 优化 Prompt                          [X]        │
├─────────────────────────────────────────────────────┤
│  原始 Prompt:                                        │
│  ┌──────────────────────────────────────────────┐  │
│  │ 请总结这个视频的内容                          │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  优化目标:                                           │
│  ( ) 更清晰  ( ) 更简洁  ( ) 更严格                │
│  ( ) 更完整  (●) 自定义                            │
│                                                      │
│  自定义需求:                                         │
│  ┌──────────────────────────────────────────────┐  │
│  │ 添加 JSON 格式要求，确保输出稳定              │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│         [  开始优化  ]                              │
│                                                      │
│  优化结果:                                           │
│  ┌──────────────────────────────────────────────┐  │
│  │ 基于以下视频字幕生成结构化 JSON 总结...       │  │
│  │                                              │  │
│  │ 输出格式要求:                                │  │
│  │ {"summary": "...", "key_points": [...]}      │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  改进说明:                                           │
│  • 添加了明确的 JSON 格式要求                       │
│  • 补充了输出结构定义                               │
│  • 使用具体动词替代模糊表达                         │
│                                                      │
│         [使用优化版本]  [取消]                      │
└─────────────────────────────────────────────────────┘
```

---

## 6. 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 原始 Prompt 为空 | 按钮禁用，提示"请先输入 Prompt" |
| AI 优化失败 | 显示"优化失败，请重试"，保留重试按钮 |
| 返回格式异常 | 显示原始返回内容，提示"AI 返回格式异常，请手动检查" |
| 网络超时 | 显示"请求超时，请检查网络后重试" |

---

## 7. 安全考虑

1. **Prompt 长度限制**: 最大 4000 Token，防止滥用
2. **频率限制**: 每用户每分钟最多 5 次优化请求
3. **不保存历史**: 优化结果仅用于当前会话，不持久化
4. **输入过滤**: 对原始 Prompt 进行基础 XSS 过滤

---

## 8. 后续扩展（未来版本）

- [ ] 支持流式优化，实时显示优化过程
- [ ] 保存优化历史，支持查看和复用
- [ ] 支持对比视图，高亮显示改动部分
- [ ] 开发者模式：优化系统内置模板

---

## 9. 确认记录

| 项目 | 状态 |
|------|------|
| 支持预设优化目标 | ✅ 确认 |
| 支持自定义优化目标 | ✅ 确认 |
| 优化后直接替换输入框内容 | ✅ 确认 |
| 暂不实现开发者场景 | ✅ 确认 |
| 显示改进说明 | ✅ 确认 |
