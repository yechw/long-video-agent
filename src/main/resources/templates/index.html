<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•¿è§†é¢‘æ™ºèƒ½åˆ†æåŠ©æ‰‹</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <!-- Markdown æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¬ é•¿è§†é¢‘æ™ºèƒ½åˆ†æåŠ©æ‰‹</h1>
            <p class="subtitle">ä¸Šä¼ å­—å¹•æ–‡ä»¶ï¼ŒAI å¸®ä½ é«˜æ•ˆå­¦ä¹ </p>
        </header>

        <div class="error" th:if="${error}">
            <p th:text="${error}"></p>
        </div>

        <section class="upload-section">
            <h2>ğŸ“ ä¸Šä¼ å­—å¹•æ–‡ä»¶</h2>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <input type="file" name="file" accept=".txt,.srt">
                    <span>æ”¯æŒ .txt .srt æ ¼å¼</span>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">ä¸Šä¼ æ–‡ä»¶</button>
                    <button type="submit" name="useSample" value="true" class="btn btn-secondary">
                        ä½¿ç”¨ç¤ºä¾‹å­—å¹•
                    </button>
                </div>
            </form>
        </section>

        <section class="status-section" th:if="${subtitleLoaded}">
            <div class="status-card">
                <span class="label">å½“å‰å­—å¹•ï¼š</span>
                <span class="filename" th:text="${fileName}">-</span>
                <span class="char-count" th:text="'(' + ${charCount} + ' å­—ç¬¦)'">(- å­—ç¬¦)</span>
            </div>
        </section>

        <!-- æ“ä½œåŒºåŸŸ -->
        <section class="action-section" th:if="${subtitleLoaded}">
            <h2>ğŸ“Š å¿«æ·æ“ä½œ</h2>
            <div class="button-group">
                <form action="/summarize" method="post" style="display:inline">
                    <input type="hidden" name="subtitleContent" th:value="${subtitleContent}">
                    <button type="submit" class="btn btn-primary">ç”Ÿæˆå…¨å±€æ€»ç»“</button>
                </form>
                <form action="/extract" method="post" style="display:inline">
                    <input type="hidden" name="subtitleContent" th:value="${subtitleContent}">
                    <button type="submit" class="btn btn-secondary">æå–çŸ¥è¯†ç‚¹</button>
                </form>
            </div>
        </section>

        <!-- æ™ºèƒ½é—®ç­”åŒºåŸŸ -->
        <section class="smart-ask-section" th:if="${subtitleLoaded}">
            <h2>ğŸ¤– æ™ºèƒ½é—®ç­” (è‡ªåŠ¨è¯†åˆ«æ„å›¾)</h2>
            <p class="hint">è¾“å…¥ä»»æ„é—®é¢˜ï¼ŒAI ä¼šè‡ªåŠ¨åˆ¤æ–­ä½ çš„æ„å›¾ï¼ˆæ€»ç»“/é—®ç­”/çŸ¥è¯†ç‚¹/é‡‘å¥/æœç´¢ï¼‰</p>
            <form action="/ask" method="post">
                <input type="hidden" name="subtitleContent" th:value="${subtitleContent}">
                <div class="chat-input-wrapper">
                    <textarea name="question" placeholder="ä¾‹å¦‚ï¼šæ€»ç»“ä¸€ä¸‹è¿™ä¸ªè§†é¢‘ / æœ‰å“ªäº›é‡‘å¥ / å“ªé‡Œæåˆ°äº† Transformer" rows="3"
                              th:text="${smartQuestion}"></textarea>
                </div>
                <div class="option-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="debug" value="true">
                        æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆæ„å›¾åˆ†ç±»ç»“æœï¼‰
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">æ™ºèƒ½å›ç­”</button>
            </form>
        </section>

        <!-- æ™ºèƒ½é—®ç­”ç»“æœ -->
        <section class="result-section" th:if="${smartAnswer}">
            <h2>ğŸ¯ æ™ºèƒ½å›ç­”</h2>
            <div class="result-card">
                <p class="question-preview" th:if="${smartQuestion}">
                    <strong>é—®é¢˜ï¼š</strong><span th:text="${smartQuestion}"></span>
                </p>
                <div class="debug-info" th:if="${debugIntent}">
                    <span class="debug-badge">æ„å›¾: <strong th:text="${debugIntent}">-</strong></span>
                    <span class="debug-badge">ç½®ä¿¡åº¦: <strong th:text="${#numbers.formatDecimal(debugConfidence, 1, 2)}">-</strong></span>
                </div>
                <div class="markdown-content" th:data-content="${smartAnswer}">
                    <div class="markdown-rendered"></div>
                </div>
            </div>
        </section>

        <section class="result-section" th:if="${summary}">
            <h2>ğŸ“ è§†é¢‘æ€»ç»“</h2>
            <div class="result-card">
                <div class="markdown-content" th:data-content="${summary}">
                    <div class="markdown-rendered"></div>
                </div>
            </div>
        </section>

        <!-- çŸ¥è¯†ç‚¹æ—¶é—´çº¿ -->
        <section class="timeline-section" th:if="${concepts}">
            <h2>ğŸ“š çŸ¥è¯†ç‚¹æ—¶é—´çº¿</h2>
            <div class="timeline">
                <div class="timeline-item" th:each="concept : ${concepts}">
                    <div class="timeline-time">
                        <span th:text="${concept.timestampFrom}">00:00:00</span>
                        <span class="time-arrow">â†’</span>
                        <span th:text="${concept.timestampTo}">00:00:12</span>
                    </div>
                    <div class="timeline-content">
                        <h3 class="concept-name" th:text="${concept.concept}">çŸ¥è¯†ç‚¹åç§°</h3>
                        <p class="concept-desc" th:text="${concept.description}">çŸ¥è¯†ç‚¹æè¿°</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- é—®ç­”åŒºåŸŸ -->
        <section class="chat-section" th:if="${subtitleLoaded}">
            <h2>ğŸ’¬ é—®ç­”å¯¹è¯</h2>
            <form action="/chat" method="post">
                <input type="hidden" name="subtitleContent" th:value="${subtitleContent}">
                <div class="chat-input-wrapper">
                    <textarea name="question" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="3"
                              th:text="${question}"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">å‘é€æé—®</button>
            </form>
        </section>

        <section class="result-section" th:if="${answer}">
            <h2>ğŸ¤– AI å›ç­”</h2>
            <div class="result-card">
                <p class="question-preview" th:if="${question}">
                    <strong>é—®é¢˜ï¼š</strong><span th:text="${question}"></span>
                </p>
                <pre th:text="${answer}"></pre>
            </div>
        </section>

        <footer>
            <p>åŸºäº Spring AI Alibaba | å­¦ä¹ é¡¹ç›®</p>
        </footer>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // é…ç½® marked
    marked.setOptions({
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true
    });

    // æ¸²æŸ“æ‰€æœ‰ markdown-content
    document.querySelectorAll('.markdown-content').forEach(function(el) {
        const content = el.getAttribute('data-content');
        if (content) {
            const rendered = el.querySelector('.markdown-rendered');
            rendered.innerHTML = marked.parse(content);
        }
    });
});
</script>
</body>
</html>
